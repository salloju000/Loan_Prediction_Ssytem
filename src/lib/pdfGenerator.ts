import { jsPDF } from 'jspdf'
import 'jspdf-autotable'
import type { LoanPredictResponse } from './types'
import { formatCurrency } from './utils'

/**
 * pdfGenerator.ts
 *
 * Professional utility to generate a loan report PDF.
 * Uses jspdf-autotable for clean, structured data presentation.
 */

export const generateLoanReport = (
  result: LoanPredictResponse,
  loanType: string,
) => {
  // Use 'any' for the document instance to avoid complex type merging issues 
  // between jsPDF and the autoTable plugin in this environment. 
  const doc = new jsPDF() as any
  const pageWidth = doc.internal.pageSize.getWidth()
  const applicantName = result.applicant_name || 'Valued Applicant'

  // 1. Header & Title
  doc.setFontSize(22)
  doc.setFont('helvetica', 'bold')
  doc.text('LoanPredict — Eligibility Report', 14, 22)

  doc.setFontSize(10)
  doc.setFont('helvetica', 'normal')
  doc.setTextColor(100)
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 28)
  doc.text(`Applicant: ${applicantName}`, 14, 33)

  // 2. Summary Section
  doc.setDrawColor(200)
  doc.line(14, 38, pageWidth - 14, 38)
  
  doc.setFontSize(16)
  doc.setTextColor(0)
  doc.text('Summary', 14, 50)

  const summaryData = [
    ['Loan Type', loanType.toUpperCase()],
    ['Status', result.approved ? 'APPROVED' : 'REJECTED'],
    ['Approval Confidence', `${result.approval_probability}%`],
    ['Loan Grade', result.loan_grade],
    ['Processing Time', `${result.processing_time_ms.toFixed(0)} ms`]
  ]

  doc.autoTable({
    startY: 55,
    head: [['Field', 'Value']],
    body: summaryData,
    theme: 'striped',
    headStyles: { fillColor: [40, 40, 40] },
    margin: { left: 14 }
  })

  // 3. Financial Breakdown
  let currentY = (doc as any).lastAutoTable.finalY + 15
  doc.setFontSize(16)
  doc.text('Financial Health', 14, currentY)

  const fh = result.breakdown.financial_health
  const cp = result.breakdown.credit_profile
  
  const financialData = [
    ['Total Monthly Income', fh.total_monthly_income],
    ['Free Monthly Income', fh.free_monthly_income],
    ['Debt-to-Income (DTI)', fh.debt_to_income_ratio],
    ['Credit Score', `${cp.credit_score} (${cp.credit_score_band})`],
    ['Existing Active Loans', cp.existing_loans.toString()],
    ['High Risk Flag', cp.is_high_risk_flag ? 'Yes' : 'No']
  ]

  doc.autoTable({
    startY: currentY + 5,
    head: [['Metric', 'Details']],
    body: financialData,
    theme: 'grid',
    headStyles: { fillColor: [40, 40, 40] },
    margin: { left: 14 }
  })

  // 4. Sanction Details (if approved)
  if (result.approved) {
    currentY = (doc as any).lastAutoTable.finalY + 15
    doc.setFontSize(16)
    doc.text('Sanctioning Details', 14, currentY)

    const sanctionData = [
      ['Requested Amount', formatCurrency(result.loan_amount_requested)],
      ['Sanctioned Amount', formatCurrency(result.sanctioned_amount)],
      ['Sanction Ratio', `${result.sanction_ratio}%`],
      ['Monthly EMI', formatCurrency(result.monthly_emi)]
    ]

    doc.autoTable({
      startY: currentY + 5,
      body: sanctionData,
      theme: 'plain',
      styles: { fontSize: 12, cellPadding: 2 },
      margin: { left: 14 }
    })
  } else {
    // Rejection reasons
    currentY = (doc as any).lastAutoTable.finalY + 15
    doc.setFontSize(16)
    doc.text('Rejection Reasons', 14, currentY)
    
    doc.setFontSize(11)
    doc.setTextColor(100)
    result.rejection_reasons.forEach((reason, i) => {
      doc.text(`• ${reason}`, 14, currentY + 10 + (i * 7))
    })
  }

  // Footer footer
  const footerY = doc.internal.pageSize.getHeight() - 20
  doc.setFontSize(9)
  doc.setTextColor(150)
  doc.text('This report is generated by LoanPredict AI. This is not a final legal offer.', 14, footerY)
  doc.text('© 2026 LoanPredict. All rights reserved.', pageWidth - 14, footerY, { align: 'right' })

  // Save PDF
  doc.save(`LoanPredict_Report_${applicantName.replace(/\s+/g, '_')}.pdf`)
}
